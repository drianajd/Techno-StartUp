<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Job Details</title>
  <link rel="stylesheet" href="/Server/public/css/jobdesc.css">
</head>
<body>
  <div class="container" id="jobContainer">
    <header>
      <button class="back-btn" onclick="window.location.href='/dashboard'">‚Üê</button>
      <span class="time" id="currentTime"></span>
      <div class="menu-btn">‚ãÆ</div>
    </header>
    <main>
      <div class="loading" id="loading">Loading job details...</div>
      <div class="job-card" id="jobCard" style="display: none;">
        <!-- Dynamic content will be populated here -->
      </div>
    </main>
    <footer>
      <button class="save-btn" id="saveBtn">SAVE</button>
    </footer>
  </div>

  <script>
    // Get job ID from URL
    const urlParams = new URLSearchParams(window.location.pathname.split('/').pop() ? 
      window.location.pathname.split('/').slice(-1)[0] : new URLSearchParams(window.location.search));
    const jobId = urlParams.get('id') || window.location.pathname.split('/').pop();

    async function loadJobDetails() {
      try {
        const response = await fetch(`/api/jobs/${jobId}`, { credentials: 'include' });
        const job = await response.json();
        
        if (!response.ok) {
          alert(job.error || 'Job not found');
          window.location.href = '/dashboard';
          return;
        }

        // Check favorite status
        const favoriteResponse = await fetch(`/api/jobs/${jobId}/favorite`, { credentials: 'include' });
        const favoriteData = await favoriteResponse.json();
        
        renderJobDetails(job, favoriteData.favorited);
        setupEventListeners(job);
      } catch (error) {
        console.error('Error loading job:', error);
        window.location.href = '/dashboard';
      }
    }

    function renderJobDetails(job, isFavorited) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('jobCard').style.display = 'block';

      const facilitiesList = job.facilities ? job.facilities.map(f => `<li>${f}</li>`).join('') : '<li>No facilities listed</li>';
      
      document.getElementById('jobCard').innerHTML = `
        <div class="job-header">
          <img src="${job.logo_url || 'res/default-logo.png'}" alt="${job.company_name} Logo" class="company-logo" onerror="this.src='res/default-logo.png'">
          <div class="job-info">
            <h2>${job.title}</h2>
            <p>${job.company_name} ‚Ä¢ ${job.location} ‚Ä¢ ${new Date(job.created_at).toLocaleDateString()}</p>
          </div>
        </div>
        <div class="job-section">
          <h3>Job Type</h3>
          <p>On-the-Job Training</p>
        </div>
        <div class="job-section">
          <h3>Description</h3>
          <p>${job.description || 'Job description not available.'}</p>
        </div>
        <div class="job-section">
          <h3>Requirements</h3>
          <ul>${job.requirements ? job.requirements.split('\n').map(req => `<li>${req.trim()}</li>`).join('') : '<li>Requirements not specified</li>'}</ul>
        </div>
        <div class="job-section">
          <h3>Location</h3>
          <p>${job.location}</p>
          <div class="map-placeholder">
            <div style="text-align: center; padding: 20px; color: #666;">üó∫Ô∏è Map coming soon</div>
          </div>
        </div>
        <div class="job-section">
          <h3>Information</h3>
          <div class="info-item">
            <h4>Position</h4>
            <p>${job.title}</p>
          </div>
          <div class="info-item">
            <h4>Company</h4>
            <p>${job.company_name}</p>
          </div>
          <div class="info-item">
            <h4>Job Type</h4>
            <p>On-the-Job Training</p>
          </div>
          <div class="info-item">
            <h4>Specialization</h4>
            <p>${job.category || 'General'}</p>
          </div>
          ${job.applied ? `
          <div class="info-item">
            <h4>Status</h4>
            <p style="color: ${job.applicationStatus === 'accepted' ? '#27ae60' : job.applicationStatus === 'rejected' ? '#e74c3c' : '#f39c12'}">
              ${job.applicationStatus?.toUpperCase() || 'PENDING'}
            </p>
          </div>` : ''}
        </div>
        <div class="job-section">
          <h3>Facilities and Others</h3>
          <ul>${facilitiesList}</ul>
        </div>
        ${job.applied ? `
        <div class="job-section">
          <h3>Application Status</h3>
          <p>You have ${job.applicationStatus === 'accepted' ? 'been accepted for' : job.applicationStatus === 'rejected' ? 'been rejected from' : 'applied to'} this position.</p>
        </div>` : ''}
      `;

      // Update save button
      const saveBtn = document.getElementById('saveBtn');
      saveBtn.textContent = isFavorited ? 'SAVED' : 'SAVE';
      saveBtn.style.background = isFavorited ? '#27ae60' : '#4a90e2';
    }

    function setupEventListeners(job) {
      // Update time
      function updateTime() {
        document.getElementById('currentTime').textContent = new Date().toLocaleTimeString('en-US', { 
          hour: 'numeric', 
          minute: '2-digit' 
        });
      }
      updateTime();
      setInterval(updateTime, 1000);

      // Save/Favorite button
      document.getElementById('saveBtn').addEventListener('click', async () => {
        try {
          const response = await fetch(`/api/jobs/${jobId}/favorite`, {
            method: 'POST',
            credentials: 'include'
          });
          const data = await response.json();
          
          if (data.success) {
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.textContent = data.favorited ? 'SAVED' : 'SAVE';
            saveBtn.style.background = data.favorited ? '#27ae60' : '#4a90e2';
          }
        } catch (error) {
          console.error('Error toggling favorite:', error);
        }
      });

      // Apply button if not applied
      if (!job.applied) {
        const applyBtn = document.createElement('button');
        applyBtn.textContent = 'APPLY NOW';
        applyBtn.className = 'apply-btn';
        applyBtn.style.cssText = `
          background: #27ae60; color: white; border: none; padding: 12px; 
          border-radius: 10px; width: 100%; margin-top: 10px; font-size: 16px; cursor: pointer;
        `;
        applyBtn.onclick = () => applyForJob(job.id);
        document.querySelector('.job-card').appendChild(applyBtn);
      }
    }

    async function applyForJob(jobId) {
      try {
        const response = await fetch('/api/applications', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ jobId })
        });
        
        const result = await response.json();
        if (result.success) {
          alert('Application submitted successfully!');
          window.location.reload();
        } else {
          alert('Error: ' + (result.error || 'Failed to apply'));
        }
      } catch (error) {
        alert('Network error. Please try again.');
      }
    }

    // Check authentication first
    window.addEventListener('load', async () => {
      try {
        const authResponse = await fetch('/api/me', { credentials: 'include' });
        const authData = await authResponse.json();
        if (!authData.loggedIn) {
          window.location.href = '/login.html';
        } else {
          loadJobDetails();
        }
      } catch (error) {
        window.location.href = '/login.html';
      }
    });
  </script>
</body>
</html>